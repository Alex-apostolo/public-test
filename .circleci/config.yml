version: 2.1

jobs:
  detect-fork:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: "Check if this is a fork"
          command: |
            if [ -n "$CIRCLE_PR_USERNAME" ]; then
              echo "This is a fork. Requiring approval."
              echo "export REQUIRE_APPROVAL=true" >> $BASH_ENV
            else
              echo "Internal PR or branch."
              echo "export REQUIRE_APPROVAL=false" >> $BASH_ENV
            fi
      - run: source $BASH_ENV
      - persist_to_workspace:
          root: .
          paths:
            - $BASH_ENV

  hold-if-fork:
    docker:
      - image: cimg/base:stable
    steps:
      - attach_workspace:
          at: .
      - run:
          name: "Check if approval needed"
          command: |
            source $BASH_ENV
            if [ "$REQUIRE_APPROVAL" = "true" ]; then
              echo "Approval required for fork"
              exit 1
            else
              echo "No approval needed for internal PR"
              exit 0
            fi

  test:
    docker:
      - image: cimg/base:stable
    steps:
      - run: echo "Running tests..."

workflows:
  fork-aware:
    jobs:
      - detect-fork
      - hold-if-fork:
          requires:
            - detect-fork
          filters:
            branches:
              only: /.*/  # adjust as needed
      - test:
          requires:
            - detect-fork
            - hold-if-fork
